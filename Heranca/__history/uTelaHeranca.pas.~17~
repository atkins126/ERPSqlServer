unit uTelaHeranca;

interface

uses
  Winapi.Windows,
  Winapi.Messages,
  System.SysUtils,
  System.Variants,
  System.Classes,
  Vcl.Graphics,
  Vcl.Controls,
  Vcl.Forms,
  Vcl.Dialogs,
  Data.DB,
  Vcl.Grids,
  Vcl.DBGrids,
  Vcl.StdCtrls,
  Vcl.Buttons,
  Vcl.Mask,
  Vcl.ComCtrls,
  Vcl.ExtCtrls,
  ZAbstractRODataset,
  ZAbstractDataset,
  ZDataset,
  Vcl.DBCtrls,
  uDTMConexao,
  uEnum2;

type
  TfrmTelaHeranca = class(TForm)
    pnlRodape: TPanel;
    pgcPrincipal: TPageControl;
    tabListagem: TTabSheet;
    tabManutencao: TTabSheet;
    pnlListagemTopo: TPanel;
    mskPesquisar: TMaskEdit;
    btnPesquisar: TBitBtn;
    grdListagem: TDBGrid;
    btnNovo: TBitBtn;
    btnAlterar: TBitBtn;
    btnCancelar: TBitBtn;
    btnGravar: TBitBtn;
    btnExcluir: TBitBtn;
    dbnNavigator: TDBNavigator;
    btnFechar: TBitBtn;
    qryListagem: TZQuery;
    dtsListagem: TDataSource;
    lblIndice: TLabel;
    procedure FormCreate(Sender: TObject);
    procedure btnFecharClick(Sender: TObject);
    procedure btnNovoClick(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure btnGravarClick(Sender: TObject);
    procedure btnExcluirClick(Sender: TObject);
    procedure btnAlterarClick(Sender: TObject);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);

  private
    { Private declarations }
    EstadoDoCadastro : TEstadoDoCadastro;

    procedure ControlarBotoes (btnNovo, btnFechar, btnAlterar, btnCancelar ,
                btnGravar, btnExcluir : TBitBtn; dbnNavigator : TDBNavigator;
               pgcPrincipal : TPageControl; Flag : Boolean);

    procedure ControlarIndiceTab(pgcPrincipal: TPageControl; i: Integer);


  public
    { Public declarations }
  end;

var
  frmTelaHeranca: TfrmTelaHeranca;
  FEmModoEdicao: Boolean;

implementation

{$R *.dfm}

  // PROCEDURE PARA CONTROLAR VISIBILIDADE DOS BOTÕES
procedure TfrmTelaHeranca.ControlarBotoes (btnNovo, btnFechar, btnAlterar, btnCancelar,
          btnGravar, btnExcluir : TBitBtn; dbnNavigator : TDBNavigator;
          pgcPrincipal : TPageControl; Flag : Boolean);
begin
  btnNovo.Enabled         := Flag;
  btnExcluir.Enabled      := Flag;
  btnAlterar.Enabled      := Flag;
  dbnNavigator.Enabled    := Flag;
  btnFechar.Enabled       := Flag;

  pgcPrincipal.Pages[0].TabVisible := Flag;
  btnCancelar.Enabled := not(Flag);
  btnGravar.Enabled := not(Flag);
end;

  // PROCEDURE PARA CONTROLAR O INDECE DO PAGECONTROL
procedure TfrmTelaHeranca.ControlarIndiceTab(pgcPrincipal : TPageControl; i: Integer);
begin
  if (pgcPrincipal.Pages[I].TabVisible) then
  pgcPrincipal.TabIndex := 0;
end;

  // PROCEDURE PARA IMPEDIR O FECHAMENTO DA TELA ANTES DE SALVAR OU CANCELAR
procedure TfrmTelaHeranca.FormCloseQuery(Sender: TObject;
  var CanClose: Boolean);
begin
  if FEmModoEdicao then
  begin
    if MessageDlg('Alteração ainda não salva, deseja realmente sair?', mtConfirmation, [mbYes, mbNo], 0) = mrNo then
    begin
      CanClose := False; //Impede o fechamento do formulário
    end;
  end;
end;

  // INICIO DOS BOTÕES

procedure TfrmTelaHeranca.btnNovoClick(Sender: TObject);      // BOTÃO NOVO
begin
  ControlarBotoes(btnNovo, btnFechar, btnAlterar, btnCancelar, btnGravar,
                  btnExcluir, dbnNavigator, pgcPrincipal,false);

  FEmModoEdicao := True; //Indica que o formulário está em modo de edição

  EstadoDoCadastro := ecInserir;

end;


procedure TfrmTelaHeranca.btnAlterarClick(Sender: TObject);    // BOTÃO ALTERAR
begin
  FEmModoEdicao := True;

  ControlarBotoes(btnNovo, btnFechar, btnAlterar, btnCancelar, btnGravar,
                  btnExcluir, dbnNavigator, pgcPrincipal,false);

  EstadoDoCadastro := ecAlterar;

end;

procedure TfrmTelaHeranca.btnCancelarClick(Sender: TObject);   // BOTÃO CANCELAR
begin
  FEmModoEdicao := False; //Sai do modo de edição


    ControlarBotoes(btnNovo, btnFechar, btnAlterar, btnCancelar, btnGravar,
                    btnExcluir, dbnNavigator, pgcPrincipal,true);
    ControlarIndiceTab(pgcPrincipal, 0);

    EstadoDoCadastro := ecNenhum;

end;

procedure TfrmTelaHeranca.btnExcluirClick(Sender: TObject);    // BOTÃO EXCLUIR
begin
  ControlarBotoes(btnNovo, btnFechar, btnAlterar, btnCancelar, btnGravar,
                  btnExcluir, dbnNavigator, pgcPrincipal,true);

  ControlarIndiceTab(pgcPrincipal, 0);

  EstadoDoCadastro := ecNenhum;

end;

procedure TfrmTelaHeranca.btnFecharClick(Sender: TObject);     // BOTÃO FECHAR
begin
  Close;
end;

procedure TfrmTelaHeranca.btnGravarClick(Sender: TObject);     // BOTÃO GRAVAR
begin
  FEmModoEdicao := False; // Sai do modo de edição

  try
  ControlarBotoes(btnNovo, btnFechar, btnAlterar, btnCancelar, btnGravar,
                  btnExcluir, dbnNavigator, pgcPrincipal,true);

  ControlarIndiceTab(pgcPrincipal, 0);

  finally
    EstadoDoCadastro := ecNenhum;
  end;


end;
  // FIM DOS BOTÕES


  // CONFIGURAÇÃO DAS CONEXÕES COM O BANCO DOS COMPONENTES
procedure TfrmTelaHeranca.FormCreate(Sender: TObject);
begin
  if not dtmConexao.ConexaoDB.Connected then
    dtmConexao.ConexaoDB.Connect;

  qryListagem.Connection := dtmConexao.ConexaoDB;
  dtsListagem.DataSet := qryListagem;
  grdListagem.DataSource := dtsListagem;
  dbnNavigator.DataSource := dtsListagem;

  ControlarBotoes(btnNovo, btnFechar, btnAlterar, btnCancelar, btnGravar,
                  btnExcluir, dbnNavigator, pgcPrincipal,true);
end;

end.
